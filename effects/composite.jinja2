{{ '{%' }} extends "{{ base_template }}" {{ '%}' }}
{{ '{% block globals %}' }}
{% for effect in effects %}
  {% include effect.name + ".globals.jinja2" ignore missing %}
{% endfor %}
{{ '{% endblock %}' }}
{{ '{% block effect %}' }}

aInDry = aIn

{{ '{% block parameter_init %}{% endblock %}' }}

k_softmax_post_gain_denominator = {% for effect in effects %}exp(kChannel{{ effect.parameter_indexes[-1] }}[kTime - 1]){% if not loop.last %} + {% endif %}{% endfor %}

{% for effect in effects %}
  aIn = aInDry
  {% for parameter_index in effect.parameter_indexes %}

    k_{{ parameter_names[parameter_index] }} tonek kChannel{{ parameter_index }}[kTime - 1], {{ '{{ parameter_lpf_cutoff }}' }}
  {% endfor %}
  {% include effect.name + ".effect.jinja2" %}
  a_{{ effect.name }} = aOut
{% endfor %}

aOut = ({% for effect in effects %}a_{{ effect.name }} * exp(k_{{ parameter_names[effect.parameter_indexes[-1]] }}){% if not loop.last %} + {% endif %}{% endfor %}) / k_softmax_post_gain_denominator
{{ '{% endblock %}' }}
